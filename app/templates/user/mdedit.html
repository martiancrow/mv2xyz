<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
		<meta name="format-detection" content="telephone=no">

		<title>mv2 -- edit</title>

        <link href="{{ url_for('static', filename='common.css') }}" rel="stylesheet">
        <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.38.0/codemirror.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
		<!--<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">-->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="{{ url_for('static', filename='codemirror_5.38.0.js') }}"></script>
        <script src="{{ url_for('static', filename='codemirror_importmode_5.38.0.js') }}"></script>
		<!--<script src="https://cdn.bootcss.com/codemirror/5.38.0/codemirror.min.js"></script>-->
		
        
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.19/marked.min.js"></script>
		<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.0.0/js/bootstrap.min.js"></script>-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/iScroll/5.2.0/iscroll.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/markdown.min.js"></script>
        
        
        
		
		<style type="text/css">
			html, body {height: 100%;font-size:14px;}
            .CodeMirror {font-family: SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
			.warpper {width: 100%;height: 100%;top: 0;background-color: #ddd;float: left;}
			.title {width: 100%;height: 50px;padding-left: 12px;overflow: hidden;border-bottom: 1px solid #ddd;float: left;background-color: #fff;box-sizing: border-box;}
			.title input[type=text] {width: 100%;height: 100%;border: 0px;font-size: 26px;line-height: 49px;}
			.content {width: 100%;padding-left: 12px;box-sizing: border-box;float: left;background-color: #fff;overflow:hidden;position:relative}
            #mv2_input {display: none;}
            #hide_input {opacity:0;position:absolute;width:0;height:0;top:-500px;}

			.preview {display: block;top: 0;position: absolute;width: 100%;height: 100%;background-color: #fff;z-index: 999;}
            #md-wrapper {width: 100%;overflow-x: hidden;overflow-y: auto;float: left;position:relative}
			.markdown-body {width: 100%;overflow: hidden;padding: 18px 21px;box-sizing: border-box;float: left;}
			.preview-foot {width: 100%;height: 50px;background-color: #fff;border-top: 1px solid #ddd;box-sizing: border-box;float: left;}
			.preview-foot i {line-height: 50px;float: left;cursor: pointer;}
			.preview-foot .tools-left {margin-left: 10px;height: 100%;float: left;overflow: hidden;}
			.preview-foot .tools-right {margin-right: 10px;height: 100%;float: right;overflow: hidden;}
            
            .new-file-msg {display: none;top: 0;position: absolute;width: 100%;height: 100%;background-color: rgba(0, 0, 0, 0.5);z-index: 9999;}

			.head {width: 100%;height: 50px;background-color: #fff;float: left;}
			.head i {line-height: 50px;float: left;cursor: pointer;}
			.head .tools-left {margin-left: 10px;height: 100%;float: left;overflow: hidden;}
			.head .tools-right {margin-right: 10px;height: 100%;float: right;overflow: hidden;}
			.head .tools-right .option{margin-right: 10px;}
			.head .tools-right .disable:before{color:#c0c0c0;}
			.head .tools-right .save{margin-left: 10px;}
			
			.foot {width: 100%;height: 50px;background-color: #fff;border-top: 1px solid #ddd;float: left;overflow: hidden;z-index: 999;box-sizing: border-box;}
			.foot .toolsbar {width: 100%;height: 50px;position: relative;float: left;border-bottom: 1px solid #ddd;box-sizing: border-box;}
			.foot .toolsbar i {line-height: 50px;cursor: pointer;}

			.foot .toolsbar .tools-left {margin-left: 10px;height: 100%;float: left;width: 85%;overflow: hidden;}
			.foot .toolsbar .tools-left .tools-left-warpper {height: 100%;float: left;position: relative;touch-action:none;}
			.foot .toolsbar .tools-left .option{margin-right: 25px;float: left;display: block;}
			.foot .toolsbar .tools-right {margin-right: 10px;height: 100%;float: right;overflow: hidden;}

			#upload-file {width: 100%;height: 50px;float: left;position: relative;display:none;}
            #upload-file .container-fluid {margin-left:10px;height:100%;width:calc(100% - 10px);float:left;overflow:hidden;}
			#upload-file .upload-type {overflow: hidden;}
			#upload-file .upload-type .upload-btn {margin-right: 25px;float: left;text-align: center;position: relative;height:50px;}
			#upload-file .upload-type .upload-btn i {line-height: 50px;cursor: pointer;}
			.file-upload-input {width: 100%;height: 100%;position: absolute;top: 0;z-index: 999;opacity: 0;cursor: pointer;}

			#upload-file .upload-msg {width:100%;height:100%;overflow: hidden;display: none;float:left;position:absolute;top:0;left:0;}
            #upload-file .upload-msg .progress {width:100%;height:100%;background-color:rgba(0, 0, 0, 0.8);}
            #upload-file .upload-msg .progress-txt {color:#FFF;position:absolute;z-index:999;text-align:center;line-height:50px;width:100%;height:100%;}
            #upload-file .upload-msg .progress-bar {float:left;width:0%;height:100%;background-color:rgb(48, 177, 50);position:absolute;top:0;left:0;}

		</style>
	</head>
	<body>
		<div class="warpper">
			{% if postid %}
			<input id="postid" type="hidden" value="{{ postid }}">
            <input id="updatetime" type="hidden" value="{{ updatetime }}">
			{% endif %}
            <textarea id="mv2_input">{% if content %}{{ content }}{% endif %}</textarea>
            <input id="hide_input" type="text" value=""/>
			
			<div class="head">
				<div class="tools-left">
					<i id="head-goback" class="fa fa-long-arrow-left fa-lg fa-fw"></i>
				</div>
				<div class="tools-right">
					<i id="undo-btn" class="fa fa-undo fa-lg fa-fw option disable"></i>
					<i id="redo-btn" class="fa fa-repeat fa-lg fa-fw option disable"></i>
					<i id="save-btn" class="fa fa-save fa-lg fa-fw save"></i>
				</div>					
			</div>
			<div class="title">
				<input id="title" type="text" name="title" placeholder="请输入标题" value="{% if title %}{{ title }}{% endif %}" />
			</div>
			<div class="content">
				
			</div>
			<div id="foot" class="foot">
				<div class="toolsbar">
					<div class="tools-left">
						<div id="foot-tools-left-wrapper"  class="tools-left-warpper">
							<i id="insert-head" class="fa fa-header fa-lg option"></i>
							<i id="insert-bold" class="fa fa-bold fa-lg option"></i>
                            <i id="insert-italic" class="fa fa-italic fa-lg option"></i>
                            <i id="insert-strikethrough" class="fa fa-strikethrough fa-lg option"></i>
							<i id="insert-media" class="fa fa-camera fa-lg option"></i>
							<i id="insert-quote" class="fa fa-quote-left fa-lg option"></i>
							<i id="insert-indent" class="fa fa-indent fa-lg option"></i>
                            <i id="insert-code" class="fa fa-code fa-lg option"></i>
                            <i id="insert-horizontal-rule" class="fa fa-minus fa-lg option"></i>
							<i id="insert-list-ul" class="fa fa-list-ul fa-lg option"></i>
                            <i id="insert-paperclip" class="fa fa-paperclip fa-lg option"></i>
                            <!--<i id="insert-list-ol" class="fa fa-list-ol fa-lg option"></i>-->
                            <i id="insert-check-square-o" class="fa fa-check-square-o fa-lg option"></i>
                            <i id="insert-square-o" class="fa fa-square-o fa-lg option"></i>
                            <i id="insert-link" class="fa fa-link fa-lg option"></i>
                            <i id="insert-tag" class="fa fa-tag fa-lg option"></i>
                            <i id="insert-table" class="fa fa-table fa-lg option"></i>
							<!--<i id="insert-upload" class="fa fa-upload fa-lg option"></i>-->

						</div>
					</div>
					<div class="tools-right">
						<i id="show-preview" class="fa fa-desktop fa-lg"></i>
					</div>	
				</div> 
				<div id="upload-file">
					<div class="container-fluid">
    					<div class="upload-type">
    						<div class="upload-btn">
    							<input class="file-upload-input" id="file-img-upload" accept="image/*" type="file">
    							<i class="fa fa-file-image-o fa-lg option"></i>
    						</div>
                            <div class="upload-btn">
    							<input class="file-upload-input" id="file-movie-upload" accept="video/*" type="file">
    							<i class="fa fa-file-movie-o fa-lg option"></i>
    						</div>
                            <div class="upload-btn">
    							<input class="file-upload-input" id="file-audio-upload" accept="audio/*" type="file">
    							<i class="fa fa-file-audio-o fa-lg option"></i>
    						</div>
                            <div class="upload-btn">
    							<input class="file-upload-input" id="file-file-upload" accept="" type="file">
    							<i class="fa fa-file-o fa-lg option"></i>
    						</div>
    					</div>
					</div>
                    <div class="upload-msg">
                        <div class="progress">
                            <div class="progress-txt">0%</div>
                            <div class="progress-bar"></div>
                        </div>
                    </div>
				</div>		
			</div>
			<div class="preview">
                <div id="md-wrapper">
                    <div class="markdown-body"></div>
                </div>
				<div class="preview-foot">
					<div class="tools-left">
						<i id="del-post" class="fa fa-trash-o fa-lg"></i>
					</div>
					<div class="tools-right">
						<i id="hide-preview" class="fa fa-edit fa-lg"></i>
					</div>					
				</div>
			</div>
            <div class="new-file-msg">
                这里是预览视图,点我进入页面
			</div>
		</div>	
        <script type="text/javascript">
        
            function utilTools () {
            
                var outs = new Object;
            
                outs.checkDriver = function () {
                
                    var ua = navigator.userAgent; 
                    var app = navigator.appVersion;
                    
                    
                    if (!!ua.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)) {
                        if (ua.indexOf('iPhone') > -1) {

                            if (ua.indexOf('MQQBrowser') > -1) {
                            
                                return 'ios_iphone_mqqb';
                            }
                            else if (ua.indexOf('MicroMessenger') > -1) {
                            
                                return 'ios_iphone_mwxb';
                            }
                            else if (navigator.standalone) {
                            
                                return 'ios_iphone_safari_webapp';
                            }
                        
                            return 'ios_iphone_safari';
                        }
                        else if (ua.indexOf('iPad') > -1) {
                        
                            return 'ios_ipad_safari';
                        }
                    
                        return 'ios';
                    }
                    else if (ua.indexOf('Android') > -1 || ua.indexOf('Linux') > -1) {
                        
                        return 'android'
                    }
                    
                    return  'other';

                };
                
                return outs;
            }
        
        </script>
        
        <script type="text/javascript">
        
            function scrollHelper (_edit) {
            
                this._init_ = function () {
                    this._edit = _edit;
                    this._drvtype = utilTools().checkDriver();
                    
                    if (this._drvtype.indexOf('ios')  > -1) {
                        $("#md-wrapper").css("overflow-y", "hidden");
                        
                        this._htmlScroll = new IScroll('#md-wrapper', {
                            preventDefault: true,
                            preventDefaultException: {
                                tagName: /^(INPUT|TEXTAREA|BUTTON|SELECT|A|PRE|CODE)$/
                            },
                            disableMouse: true,
                            disablePointer: true,
                            scrollbars: true,
                            hScrollbar: false,  
                            vScroll: true,      
                            bounce: true,      
                            tap: "htmlscrolltap",
                            mouseWheel: true,
                            fadeScrollbars: true,
                            scrollbars: true
                        });
                   
                        this._editScroll = new IScroll('.content', {
                            preventDefault: false,
                            disableMouse: true,
                            disablePointer: true,
                            hScrollbar: false,  
                            vScroll: true,      
                            bounce: true,      
                            click: true,    　     //有bug,true的时候checkbox 不能点击,false的时候超链接不能点击
                            mouseWheel: true,
                            fadeScrollbars: true,
                            scrollbars: true
                        });

                    }

                }
                
                this.refReshHtml = function () {
                    if (this._drvtype.indexOf('ios')  > -1) {
                        setTimeout(function () {
                            this._htmlScroll.refresh();
                        }.bind(this), 0);
                    }
                };
                
                this.refReshEdit = function () {
                    if (this._drvtype.indexOf('ios')  > -1) {
                        setTimeout(function () {
                            this._editScroll.refresh();
                        }.bind(this), 0);
                    }
                };
                
                this._init_();
            }
            
        </script>
        
        <script type="text/javascript">
        
            function screenHelper (_edit, _scroll) {
            
                this._init_ = function () {
                    this._edit = _edit;
                    this._scroll = _scroll;
                    this._isPreven = false;
                    this._keyoutcontentHeight = 0;
                    this._keyHeight = 0;
                    
                    this._additiveHeight = 0;
                    
                    this._firstOpenKey = true;
                    this._enterOpenKey = true;
                    this._orientationMsg = false;
                    this._autoScrollHideInputCanChange = true;
                    
                    this._drvtype = utilTools().checkDriver();
                    this._onlLoadHeight();
                    this.setSize();
                    this._prevenMove();
                    this._checkAdditiveHeight();
                    
                    
                    
                    if (this._drvtype.indexOf('ios')  > -1) {
                    
                        //console.log("navigator.userAgent:" + navigator.userAgent)
                        //console.log("navigator.appVersion:" + navigator.appVersion)
                        
                        //alert(navigator.userAgent)
                        
                        /*
                        setInterval(function () {
                            console.log("window.innerHeight:" + window.innerHeight)
                            console.log("document.documentElement.clientHeight:" + document.documentElement.clientHeight)
                            console.log("bodyScrollTop:" + $("body").scrollTop())
                            console.log("bodyHeight:" + $("body").height())
                            
                        }, 1000);
                        */
                    
                        $(window).scroll(function(event) {
                            this._heightLoop();
                            if (!this._firstOpenKey) {
                                setTimeout(function () {
                                    if ($('body').scrollTop() != 0) {
                                        $('body').scrollTop(0)
                                    }
                                }.bind(this), 100);
                            }
                            
                        }.bind(this));
                        
                        $("#hide_input").bind('focus', function () {
                            if (this._firstOpenKey || this._enterOpenKey) {
                                this.onKeyChange("open");
                                $("#title").focus();
                            }
                        }.bind(this))
                        
                        $("#hide_input").bind('blur', function () {

                            if (!this._firstOpenKey || !this._enterOpenKey) {
                            
                                this.onKeyChange("close");
                            }
                        }.bind(this));

                        /*
                        this._edit.on('focus', function () {
                            this.onKeyChange("open");
                        }.bind(this));
                        */
                        
                        this._edit.on('blur', function () {
                            this.onKeyChange("close");
                        }.bind(this));
                        
                        $("#title").bind('focus', function () {
                            if ($("#title").attr("readonly")) {
                                $("#title").blur();
                                return false;
                            }
                        
                            if (this._firstOpenKey || this._enterOpenKey) {
                                this._firstOpenKey = false;
                                this._enterOpenKey = false;
                            }
                            else {
                                this.onKeyChange("open");
                            }
                        }.bind(this));
                        
                        $("#title").bind('blur', function () {
                            this.onKeyChange("close");
                        }.bind(this));
                        
                        $(".content").bind('touchstart', function () {
                            if (this._edit.doc.height < $('.content').height()) {
                                this._edit.focus();
                                return false;
                            }
                        }.bind(this));
                        
                        this._scroll._editScroll.on('scrollEnd', function () {
                        
                            if (this._edit.hasFocus() || $('#hide_input').is(":focus")) {
                            
                                this.autoScroll('scrollend');
                            }
                        }.bind(this));
                        
                       
                        
                        $("#hide_input").bind('input', function () {
                        
                            setTimeout(function () {
                                this.autoScroll('hide_input_oninput');
                            }.bind(this), 0);
                        }.bind(this)).on('compositionstart', function () {

                            this._autoScrollHideInputCanChange = false;
                        }.bind(this)).on('compositionend', function () {

                            this._autoScrollHideInputCanChange = true;
                        }.bind(this));

                        this._onlLoadHeight();
                        this._scroll.refReshHtml();
                        this._scroll.refReshEdit();

                    }
                    else {
                        window.onresize = function () {
                            this.setSize();

                        }.bind(this);
                    }
                    
                    window.onorientationchange = function () {
                        this._hideKey();
                        this.listenOrientation();
                                                
                        setTimeout(function () {
                            
                            this.setSize();
                            
                        }.bind(this), 0);
                                                
                    }.bind(this);
                    

                };
                
                this._onlLoadHeight = function () {
                    this._loadcontentHeight = $('.content').height();
                    this._loadinnerHeight = window.innerHeight;
                };

                this._checkAdditiveHeight = function () {
                    
                    if (this._drvtype == 'ios_iphone_safari') { 
                        this._additiveHeight = 45;
                    }
                };
                
                this._prevenMove = function () {
                    
                    if (this._drvtype.indexOf('ios')  > -1) {
                    
                        $('html').bind('touchmove', function (e) {
                            if ($('.preview').is(':hidden')) {
                                e.preventDefault();
                            }
                        }.bind(this));
                    
                        $('body').bind('touchmove', function (e) {
                            if ($('.preview').is(':hidden')) {
                                e.preventDefault();
                            }
                        }.bind(this));
                        
                        $('.warpper').bind('touchmove', function (e) {
                            if ($('.preview').is(':hidden')) {
                                e.preventDefault();
                            }
                        }.bind(this));
                        
                        $('.head').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                    
                        $('.title').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                        
                        $('.content').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                        
                        $('.foot').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                        
                        $('#md-wrapper').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                        
                        $('.preview-foot').bind('touchmove', function (e) {
                            e.preventDefault();
                        }.bind(this));
                    
                    }
                };
                
                this._openKey = function () {

                    if ($('.content').height() > this._keyoutcontentHeight) {
                    
                        if (this._firstOpenKey) {
                            
                            $("body").scrollTop(this._loadinnerHeight);
                            setTimeout(function () {
                                
                                if (this._drvtype.indexOf('iphone') > -1) {
                                    
                                }
                                
                                $("#foot")[0].scrollIntoView();

                                setTimeout(function () {
                                    this._setcontentHeight();
                                    //this.autoScroll("focus");
                                }.bind(this), 100);
                                
                            }.bind(this), 700);
                        }
                        else {

                            this._setcontentHeight();
                            //this.autoScroll("focus");
                        }
                    }
                };
                
                this._closeKey = function () {
                    var tbxTitle = $("#title")[0];
                    
                    var titleFocus = (document.activeElement == tbxTitle);
                    var contentFocus = this._edit.hasFocus();
                    
                    if (!titleFocus && !contentFocus) {
                        if (!this._isPreven) {
                            if ($('.content').height() <= this._keyoutcontentHeight) {
                                this._setcontentHeight();
                            }
                        }
                    }
                    
                    this.acceptChange();
                };
                
                this._hideKey = function () {
                    this.acceptChange();
                    document.activeElement.blur();
                }

                this._setcontentHeight = function () {
                
                    if (!this._keyoutcontentHeight || !this._loadcontentHeight) {
                        return;
                    }
                
                    if ($('.content').height() > this._keyoutcontentHeight) {
                        $('.content').height(this._keyoutcontentHeight);
                    }
                    else
                    {
                        $('.content').height(this._loadcontentHeight);
                    }
                    
                    $('body').scrollTop(0);
                    
                    this._scroll.refReshEdit();

                };
                
                this._heightLoop = function () {
                
                    //prevent scrollIntoView scroll too more
                    var temkoch = this._loadcontentHeight - $('body').scrollTop() + this._additiveHeight;

                    if (temkoch > 0 && $('body').scrollTop() > this._keyHeight && window.innerHeight != this._loadinnerHeight) {
                        this._keyHeight = $('body').scrollTop();                    
                        this._keyoutcontentHeight = this._loadcontentHeight - this._keyHeight + this._additiveHeight;
                        
                    }
                    
                    
                };
                
                this.autoScroll = function (_type) {
                    
                    if (this._drvtype.indexOf('ios') > -1) {
                    

                        var cursor = this._edit.getCursor();
                        
                        var focusHeight = 0;

                        for (var i = 0; i <= cursor.line; i++) {
                            focusHeight += this._edit.display.view[i].line.height;
                        }
                                                
                        var scrollHeight = Math.abs(this._scroll._editScroll.y);
                        var viewportHeight = $(".content").height();
                        
                        var unvpsc = function () {
                        
                            var autoScrollheight = focusHeight - viewportHeight + this._edit.display.cachedTextHeight;
                            autoScrollheight = autoScrollheight * -1;
                            autoScrollheight = autoScrollheight < this._scroll._editScroll.maxScrollY ? this._scroll._editScroll.maxScrollY : autoScrollheight;
                            this._scroll._editScroll.scrollTo(0, autoScrollheight, 0);
                            this._edit.replaceSelection(' ');
                            this._edit.replaceRange('', {line: cursor.line, ch: cursor.ch}, {line: cursor.line, ch: cursor.ch + 1});
                        }.bind(this);
                        
                        var upvpsc = function () {
                        
                            var autoScrollheight = focusHeight - this._edit.display.cachedTextHeight;
                            autoScrollheight = autoScrollheight * -1;
                            autoScrollheight = autoScrollheight > 0 ? 0 : autoScrollheight;
                            this._scroll._editScroll.scrollTo(0, autoScrollheight, 0);
                            this._edit.replaceSelection(' ');
                            this._edit.replaceRange('', {line: cursor.line, ch: cursor.ch}, {line: cursor.line, ch: cursor.ch + 1});
                        }.bind(this);
                        
                        //console.log("cursor.line:" + cursor.line)
                        //console.log("focusHeight:" + focusHeight)
                        //console.log("scrollHeight:" + scrollHeight)
                        //console.log("viewportHeight:" + viewportHeight)
                        
                        
                        
                        if (scrollHeight + viewportHeight <= focusHeight) {
                            //under the viewport
                            
                            //$(".CodeMirror").hide()
                            
                            //setTimeout(function () {
                            //    $(".CodeMirror").show()
                            //}, 0)

                            //注意解决iosweb本生的焦点对齐事件
                            //autoScrollheight = autoScrollheight > 0 ? autoScrollheight * -1 : 0;
                            
                            
                            
                            if (_type == "scrollend") {
                            
                                sch.preventChange();
                                $("#hide_input").val('');
                                $("#hide_input").focus();
                            }
                            else if (_type == "hide_input_oninput") {
                            
                                if (this._autoScrollHideInputCanChange) {
                                
                                    unvpsc();
                                }
                            }
                            else {

                                unvpsc();
                            }
                            
                          
                            //console.log("autoScrollheight:" + autoScrollheight)
                            //console.log("maxScrollY:" + this._scroll._editScroll.maxScrollY)
                            
                            //this._scroll.refReshEdit();
                        }
                        else if (scrollHeight >= focusHeight) {
                            //upper the viewport
                            
                            if (_type == "scrollend") {
                            
                                sch.preventChange();
                                $("#hide_input").val('');
                                $("#hide_input").focus();
                            }
                            else if (_type == "hide_input_oninput") {
                            
                                if (this._autoScrollHideInputCanChange) {
                                
                                    upvpsc();
                                }
                            }
                            else {

                                upvpsc();
                            }
                        
                            
                        }
                        else {
                        
                            //in the viewport
                            if (_type == "scrollend") {
                            
                                if (!this._edit.hasFocus()) {
                                    this._edit.setCursor(cursor.line, cursor.ch);
                                    this._edit.focus();
                                }
                            }
                        }
                        
                        
                        if (_type == "hide_input_oninput") {
                                                    
                            if (!this._edit.hasFocus() && this._autoScrollHideInputCanChange) {
                                var content = $("#hide_input").val();
                                $("#hide_input").val('');
                                
                                this._edit.setCursor(cursor.line, cursor.ch);
                                this._edit.replaceSelection(content);
                                this._edit.setCursor(cursor.line, cursor.ch + content.length);
                                this._edit.focus();
                            }
                        }
                        

                        
                        
                       
                        
                    
                    }
                    
                };
                
                this.setSize = function () {
                    var initfootheight = $('#foot').height() + 1; //broadheight
                    
                    var viewheight = $('.warpper').height();
                    var content_height = viewheight - ($('.title').height() + 1) - $('.head').height() - initfootheight;
                    $('.content').height(content_height);
                    
                    if (this._drvtype.indexOf('ios')  > -1) {
                        this._edit.setSize('auto', 'auto');
                    }
                    else {
                        this._edit.setSize('auto', content_height + 'px');
                    }

                    var md_wrapper_height = $('.preview').height() - ($('.preview-foot').height() + 1);
                    $('#md-wrapper').height(md_wrapper_height);

                    var foot_tools_wrapper_width = 0;

                    for (var i = 0; i < $('.tools-left-warpper i').length; i++) {
                        foot_tools_wrapper_width += $($('.tools-left-warpper i')[i]).width() + 25 + 1; //span spaces
                    }

                    $('.tools-left-warpper').width(foot_tools_wrapper_width);

                    
                };
                
                this.listenOrientation = function () {
                    
                    if (this._drvtype.indexOf('ios') > -1) {
                    
                        if (window.orientation == 90 || window.orientation == -90) {
                        
                            this._edit.setOption("readOnly", "nocursor");
                            $('#title').attr("readonly", "readonly");
                        
                            if ($('.preview').is(':hidden')) {
                                if (!this._orientationMsg) {
                                    alert("为了您获得最佳的用户体验,请在竖屏下进行编辑");
                                    this._orientationMsg = true;
                                }
                            }
                            
                            $('.preview').show();
                        }
                        else {
                        
                            this._edit.setOption("readOnly", false);
                            $('#title').removeAttr("readonly");
                            
                        }
                    }
                };
                
                this.preventChange = function () {
                    this._isPreven = true;
                };
                
                this.acceptChange = function () {
                    this._isPreven = false;
                };
                
                
                this.onKeyChange = function (_type) {
                    
                    if (this._drvtype.indexOf('ios') > -1) {
                    
                        if (_type == "open") {
                            this._openKey();
                        }
                        else {
                            setTimeout(this._closeKey.bind(this), 100);
                        }
                    }

                };
                
                this.autoOpenIosKey = function () {
                
                    if (window.orientation != 90 && window.orientation != -90) {
                        this._enterOpenKey = true;
                        $("#hide_input").focus();
                    }
                }
                
                this._init_();
                
            
            }

        </script>
        
        <script type="text/javascript">
   
            function LocalDB () {
                this.dbname = "mv2xyz";
                this.dbver = 1;
                
                this._init_ = function () {
                
                    var request = indexedDB.open(this.dbname, this.dbver);
                    
                    request.onerror = function (event) {
                        console.log("open fail:" + event.target.message);
                    }.bind(this);
                    
                    request.onsuccess = function (event) {
                        this.database = event.target.result;
                        
                        if (this.onload) {
                            this.onload()
                        }
                        
                       
                    }.bind(this);
                    
                    request.onupgradeneeded = function(event) {
                                    
                        this.database = event.target.result;
                        var objectstore = this.database.createObjectStore("content", { keyPath: "datakey" });

                    }.bind(this);
                    
                    
                    
                };
                
                this.set = function (_datakey, _datavalue) {
                
                    var data = {
                    
                        datakey : _datakey,
                        dataval : _datavalue
                        
                    }
                                
                    if (!this.database) {
                        
                        return false;
                        
                    }
                    
                    var transaction = this.database.transaction("content", "readwrite");
                    var objectStore = transaction.objectStore("content");
                    
                    var getres = objectStore.get(_datakey);
                    
                    getres.onsuccess = function (e) {
                    
                        objectStore.put(data);
                        
                    };
                    
                    return true;
                    
                };
                
                this.del = function (_datakey) {
                
                    if (!this.database) {
                    
                        return false;
                        
                    }
                
                    var transaction = this.database.transaction("content", "readwrite");
                    var objectStore = transaction.objectStore("content");
                    objectStore.delete(_datakey);
                    
                    return true;
                }
                
               
                this.get = function (_datakey, _cb) {

                    if (!this.database) {
                        
                        return false;
                        
                    }
                                
                    var transaction = this.database.transaction("content", "readwrite");
                    var objectStore = transaction.objectStore("content");
                    
                    var request = objectStore.get(_datakey);

                    
                    
                    request.onsuccess = function (e) {
                        var result = e.target.result;

                        
                        
                        if (_cb) {
                        
                            if (result) {
                                _cb(result.dataval);
                            }
                            else {
                                _cb(result);
                            }
                            
                        }
                    }
                    
                    request.onerror = function (e) {
                        console.log(e)
                    };
                    
                    return true;

                }
                
                this._init_();

            }
        </script>
        
        <script type="text/javascript">
   
            function DocCache(_edit) {

                this._init_ = function () {
                    this._edit = _edit;
                    this.db = new LocalDB();

                    this.db.onload = function () {

                        var postid = $("#postid").val();
                        var datakey = "cache_new";

                        if (postid) {
                        
                            datakey = "cache_" + postid;
                        }
                                                
                        var res = this.db.get(datakey, function (_val) {
                        
                            if (_val) {
                            
                                var content = $("#mv2_input").val();
                                var updatetime = 0;
                                
                                if ($("#updatetime").length > 0) {
                                
                                    updatetime = Date.parse(new Date($("#updatetime").val()));
                                }

                                var localupdatetime = _val.updatetime;

                                if (localupdatetime > updatetime) {
                                    if (confirm("监测到您上次未保存就退出,是否继续上次内容编辑")) {
                                        content = _val.content;
                                        updatetime = localupdatetime;
                                        
                                        this._edit.setValue(content);
                                    }
                                }

                                var data = {
                                    updatetime: updatetime,
                                    content: content
                                };

                                this.db.set(datakey, data);
                            }
                            else {

                                var content = $("#mv2_input").val();
                                var updatetime = 0;
                                
                                if ($("#updatetime").length > 0) {
                                
                                    updatetime = Date.parse(new Date($("#updatetime").val()));
                                }

                                var data = {
                                    updatetime: updatetime,
                                    content: content
                                };
                                
                                

                                this.db.set(datakey, data);
                            }
                        }.bind(this));
                        
                    }.bind(this);
                    
                };
                
                this.cache = function (_mdcode) {
                    var postid = $("#postid").val();
                    var datakey = "cache_new";
                        
                    if (postid) {
                    
                        datakey = "cache_" + postid;
                    }
                    
                    var content = _mdcode;
                    var updatetime = Date.parse(new Date());
                    
                    var data = {
                        updatetime : updatetime,
                        content : content
                    };
                            
                    this.db.set(datakey, data);
                    
                };
                
                this.clean = function () {

                    var postid = $("#postid").val();
                    var datakey = "cache_new";
                        
                    if (postid) {
                    
                        datakey = "cache_" + postid; 
                    }
                    
                    this.db.del(datakey);
                    
                };
                
                this._init_();

            }
        </script>
        
		<script type="text/javascript">
		
			document.onkeydown = function () {
				if (event.ctrlKey == true && event.keyCode == 83) {//Ctrl+S
        			event.returnvalue = false;
        			submitmd();
        			return false;
    			}
			};

			window.onload = function () {
				
                initEdit();
                                
                
                
                if ($("#postid").length == 0) {

                    hidePreview();
                
                    if (utilTools().checkDriver().indexOf("ios") > -1) {
                    
                        $(".new-file-msg").show();
                    
                        $(".new-file-msg").bind("click", function () {
                            
                            document.activeElement.blur();
                            sch.listenOrientation();
                            sch.autoOpenIosKey();
                            $(".new-file-msg").hide();
                        });
                        
                    }
                    else {
                        document.activeElement.blur();
                        $("#title").focus();
                    }

                }
                
                

			};

			function initEdit () {

				var mv2input = document.getElementById('mv2_input');
				var maxec = 0;
                
                /*
				CodeMirrorEditor = CodeMirror.fromTextArea(mv2input, {
					lineWrapping: true
				});
                */
                
                hljs.initHighlightingOnLoad();

                CodeMirrorEditor = CodeMirror($('.content')[0], {
                    value: mv2input.value,
					lineWrapping: true
				});


				var rendererMD = new marked.Renderer();

				rendererMD.listitem = function(text) {
                    
	            	if (/^\s*\[[x\s]\]\s*/.test(text)) {
		               text = text.replace(/^\s*\[\s\]\s*/, '<input type=\"checkbox\" /> ')
		                          .replace(/^\s*\[x\]\s*/,  '<input type=\"checkbox\" checked disabled /> ');

		                return "<li>" + text + "</li>";
		            }
		            else 
		            {
		                return "<li>" + text + "</li>";
		            }
		        };
                
                rendererMD.heading = function (text, level) {
                    //var escapedText = text.toLowerCase().replace(/[^\w]+/g, '-');
                    var escapedText = text.toLowerCase();
                                  
                    if (typeof(headList) != 'undefined') {
                        headList.push({
                            level: level,
                            test: text,
                            id: escapedText
                        });
                    }
                    
                    return "<h" + level + ">" + 
                               "<a id=\"" + escapedText + "\" class=\"anchor\" aria-hidden=\"true\" href=\"#" + escapedText + "\">" +
                                   "<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\">" + 
                                       "<path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path>" +
                                   "</svg>" + 
                               "</a>" +
                               text + 
                           "</h" + level + ">";
                };

				marked.setOptions({
					renderer: rendererMD,
			      	gfm: true,
			      	tables: true,
			      	breaks: false,
			      	pedantic: false,
			      	sanitize: false,
			      	smartLists: false,
			      	smartypants: false,
                    highlight: function (code) {
                        return hljs.highlightAuto(code).value;
                    }
			    });

				$('.markdown-body').html(marked(CodeMirrorEditor.getValue()));
                
                dc = new DocCache(CodeMirrorEditor);
                srh = new scrollHelper(CodeMirrorEditor);
                sch = new screenHelper(CodeMirrorEditor, srh);
                headList = new Array();
                

				//CodeMirrorEditor.setOption('lineNumbers', true);
                //CodeMirrorEditor.inputStyle
                
                CodeMirrorEditor.on('focus', function () {
                    $('.foot').height(49);
                    sch.setSize();
                    
                    sch.onKeyChange("open");
                });
                
				CodeMirrorEditor.on('change', function () {
                
                    if (utilTools().checkDriver().indexOf("ios") == -1 && utilTools().checkDriver().indexOf("android") == -1) {
                    
                        $('.markdown-body').html(marked(CodeMirrorEditor.getValue()));
                        dc.cache(CodeMirrorEditor.getValue());
                        srh.refReshHtml();
                    }
					

					var ec = CodeMirrorEditor.changeGeneration();

					if (ec > 1) {
						$('#undo-btn').removeClass('disable');
					}
					else {
						$('#undo-btn').addClass('disable');
					}

					if (ec > maxec) {
						maxec = ec;
					}

					if (ec == maxec) {
						$('#redo-btn').addClass('disable');
					}
					else {
						$('#redo-btn').removeClass('disable');
					}
                    
                    srh.refReshEdit();


				});
                
                CodeMirrorEditor.on('cursorActivity', function () {
                                    
                    
                    srh.refReshEdit();
                    
                    setTimeout(function () {
                        sch.autoScroll();
                    }, 0);

				});

				$('#head-goback').bind('click', function () {
					history.go(-1);
				});

				$('#show-preview').bind('click', function () {
					//关闭软键盘
					document.activeElement.blur();
                    
                    if (utilTools().checkDriver().indexOf("ios") > -1 || utilTools().checkDriver().indexOf("android") > -1) {
                    
                        $('.markdown-body').html(marked(CodeMirrorEditor.getValue()));
                        dc.cache(CodeMirrorEditor.getValue());
                        srh.refReshHtml();
                    }
                    
					showPreview();
				});

				$('#hide-preview').bind('click', function () {
					document.activeElement.blur();
                    sch.autoOpenIosKey();
					hidePreview();
                    sch.listenOrientation();

				});

				$('#undo-btn').bind('click', function () {
					CodeMirrorEditor.undo();
				});

				$('#redo-btn').bind('click', function () {
					CodeMirrorEditor.redo();
				});

				$('#save-btn').bind('click', function () {
					submitmd();
				});

				$('#del-post').bind('click', function () {
					if(confirm('确定要删除本笔记么,删除后将不可恢复!') == true) {
                        
						deletepost();
					}
				});
				

				$('#insert-head').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					var token = CodeMirrorEditor.getRange({line: cursor.line, ch: cursor.ch - 2}, {line: cursor.line, ch: cursor.ch});

					if (token == '# ') {

						CodeMirrorEditor.replaceRange('# ' + selctx, {line: cursor.line, ch: cursor.ch - 1}, {line: cursor.line, ch: cursor.ch});
						CodeMirrorEditor.focus();					
						CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 1);
					
					}
					else {
						
						CodeMirrorEditor.replaceSelection('# ' + selctx);
						CodeMirrorEditor.focus();					
						CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
					}

				});

				$('#insert-bold').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('**' + selctx + '**')
					CodeMirrorEditor.focus();
                    
                    if (selctx) {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 4);
                    }
                    else {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
                    }
					
				});
                
                $('#insert-italic').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('*' + selctx + '*')
					CodeMirrorEditor.focus();
                    
                    if (selctx) {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 4);
                    }
                    else {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
                    }
					
				});
                
                $('#insert-strikethrough').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('~~' + selctx + '~~')
					CodeMirrorEditor.focus();
                    
                    if (selctx) {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 4);
                    }
                    else {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
                    }
					
				});

				$('#insert-media').bind('click', function () {

					hideKeyboard();
                    //sch.preventChange();

					var footheight = $('#upload-file').height() + 49 + 1;//broad height

					if ($('.foot').height() > 49) {
                        $('#upload-file').hide();
						footheight = 49;
					}
                    else {
                        $('#upload-file').show();
                    }
                    
                    $('.foot').height(footheight);
                    
                    //CodeMirrorEditor.focus();
                    
                    sch.setSize();
                    
                    


				});

				$('#insert-quote').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('> ' + selctx);
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
				});

				$('#insert-indent').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('　' + selctx)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 1);
				});
                
                $('#insert-code').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('```\n' + selctx + '\n```')
					CodeMirrorEditor.focus();	
                    
                    CodeMirrorEditor.setCursor(cursor.line + 1, 0);
                    
				});
                
                $('#insert-horizontal-rule').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection(selctx + '\n---\n')
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line + 2, cursor.ch);
				});

				$('#insert-list-ul').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('- ' + selctx)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
				});
                
                $('#insert-paperclip').bind('click', function () {
                    sch.preventChange();
					var cursor = CodeMirrorEditor.getCursor();
                    
                    marked(CodeMirrorEditor.getValue())
                    
                    var paperclip = '**目录**  \n';
                    var toplevel = 1;
                    

                    for (var i = 0; i < headList.length; i++) {
                        
                        if (i == 0) {
                            toplevel = headList[i].level;
                        }
                        
                        var ex_level_txt = '';
                        
                        for (var j = 0; j < headList[i].level - toplevel; j++) {
                            ex_level_txt += '- '
                        }
                    
                        paperclip += '- ' + ex_level_txt + '[' + headList[i].test + '](#' + headList[i].id + ')  \n';
                    }
                    
                    CodeMirrorEditor.replaceSelection(paperclip)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch);
                    
                    headList = [];
                    
					
				});

                $('#insert-check-square-o').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('- [x] ' + selctx)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 6);
				});
                
                $('#insert-square-o').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('- [ ] ' + selctx)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 6);
				});
                
                $('#insert-link').bind('click', function () {
                    sch.preventChange();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('![连接名称](http://)')
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
				});
                
                $('#insert-tag').bind('click', function () {
                    sch.preventChange();
                    var selctx = CodeMirrorEditor.getSelection();
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection('`' + selctx + '`')
					CodeMirrorEditor.focus();	
                    
                    if (selctx) {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 2);
                    }
                    else {
                        CodeMirrorEditor.setCursor(cursor.line, cursor.ch + 1);
                    }
                    
				});
                
                $('#insert-table').bind('click', function () {
                    sch.preventChange();
                    var tablecode = '';
                    tablecode += '表头 1 | 表头 2\n';
                    tablecode += '---|---\n';
                    tablecode += '行 1 列 1 | 行 1 列 2\n';
                    tablecode += '行 2 列 1 | 行 2 列 2\n';
                    
					var cursor = CodeMirrorEditor.getCursor();
					CodeMirrorEditor.replaceSelection(tablecode)
					CodeMirrorEditor.focus();					
					CodeMirrorEditor.setCursor(cursor.line + 4, 0);
				});

				$('#foot-tools-left-wrapper').bind('mousedown', function (e) {
					premouse = mouseCoords(event);
			        ftlwm = true;
			    });

			    $('#foot-tools-left-wrapper').bind('touchstart', function (e) {
			    	//e.preventDefault();
                    
		            var touch;

		            if (window.navigator.msPointerEnabled) {
		                touch = e;
		            } else {
		                touch = e.touches[0];
		            }

		            premouse = mouseCoords(touch);
		            ftlwm = true;
			    });

			    $('.file-upload-input').bind('change', function () {
			    	//var obj = document.getElementById('file-img-upload');
                    var obj = this;
                                        
			    	if (obj.files) {

			            for (var i = 0; i < obj.files.length; i++) {

			                var fr = new FileReader();

			                fr.onload = (function (file, evt) {

			                    return function (evt) {

			                    	
			                        upload_file(file);
			                    }

			                })(obj.files[i]);

			                fr.readAsDataURL(obj.files[i])
			            }

			        }

			    });

			}

			$(document).bind('mousemove', function (e) {
				var nowmouse = mouseCoords(event);
		        ftlwmMove(nowmouse);
		    });

		    $(document).bind('mouseup', function (e) {
		    	ftlwmEnd();
		    });

		    $(document).bind('touchmove', function (e) {

		    	//e.preventDefault();
                
	            var touch;

	            if (window.navigator.msPointerEnabled) {
	                touch = e;
	            } else {
	                touch = e.touches[0];
	            }

	            var nowmouse = mouseCoords(touch);

		        ftlwmMove(nowmouse);
		    });

		    $(document).bind('touchend', function (e) {
		    	ftlwmEnd();
		    });




			//鼠标坐标获取
		    function mouseCoords(touch) {

		        if (touch.pageX || touch.pageY) {
		            return { x: touch.pageX, y: touch.pageY };
		        }
		        else {

		            return {
		                x: touch.clientX + document.body.scrollLeft - document.body.clientLeft,
		                y: touch.clientY + document.body.scrollTop - document.body.clientTop
		            };
		        }
		    }

			function showPreview() {
				$('.preview').show();
                //$(".CodeMirror").hide();
                            
                srh.refReshHtml();
			}

			function hidePreview() {
				$('.preview').hide();
                //$(".CodeMirror").show();
			}

			function ftlwmMove(nowmouse) {

				if (typeof(ftlwm) != 'undefined' && ftlwm) {

		            if (nowmouse) {
		            	var mvx = nowmouse.x - premouse.x

		            	if (typeof(ftlwm_x) != 'undefined') {
		            		mvx += ftlwm_x;
		            	}
		            	
		            	$('#foot-tools-left-wrapper').css('left', mvx);

		            }
		        }

			}

			function ftlwmEnd() {

				if (typeof(ftlwm) != 'undefined' && ftlwm) {
		    		
		    		ftlwm_x = parseFloat($('#foot-tools-left-wrapper').css('left'));
                    
	          		var minleft = ($('#foot-tools-left-wrapper').width() - $('.foot .tools-left').width() - 20) * -1;

	    			if (minleft < 0)
	    			{
	    				if (ftlwm_x > 0)
		            	{
		            		$('#foot-tools-left-wrapper').animate({left: '0'}, 100, function () {
		            			ftlwm_x = 0;
		            		});
		            	}
		            	else if (ftlwm_x < minleft)
		            	{
		            		$('#foot-tools-left-wrapper').animate({left: minleft}, 100, function () {
		            			ftlwm_x = minleft;
		            		});
		            	}
	    			}
	    			else
	    			{
	            		$('#foot-tools-left-wrapper').animate({left: '0'}, 100, function () {
	            			ftlwm_x = 0;
	            		});
	    			}

		        	ftlwm = false;
		    	}
		        
			}

			function hideKeyboard() {
    			document.activeElement.blur();
    			//console.log(CodeMirrorEditor)
    			//CodeMirrorEditor.blur();
    			$('#title').blur();
			}

			function submitmd () {
				if (typeof(issubmit) == 'undefined' || !issubmit) {
					var post_name = $('#title').val();
					var post_body_md = encodeURIComponent(CodeMirrorEditor.getValue());
					var postid = $('#postid');
					var posturl = '/user/add';
					if (postid.length) {
						posturl = '/user/edit/' + postid.val();
					}

					$.ajax({
						type: 'POST',
  						url: posturl,
  						data: 'name=' + post_name + '&body_md=' + post_body_md,
  						beforeSend: function () {
  							issubmit = true;
  						},
  						success: function (result) {

  							if (result) {
  								if (result.code == 200) {
                                    dc.clean();
  									window.location.href = result.nexturl;
  								}
  							}

  							issubmit = false;
  						},
  						error: function (er) {
  							console.log(er)
  							issubmit = false;
  						}
					});
				}
			}

			function deletepost () {
				if (typeof(issubmit) == 'undefined' || !issubmit) {
					
					var postid = $('#postid');
					var geturl = '/user/del/';

					if (postid.length == 0) {
                        dc.clean();
						alert('您还没有保存!');
						return;
					}

					geturl += postid.val()

					$.ajax({
						type: 'GET',
  						url: geturl,
  						beforeSend: function () {
  							issubmit = true;
  						},
  						success: function (result) {

  							if (result) {
  								if (result.code == 200) {
                                    dc.clean();
  									window.location.href = result.nexturl;
  								}
  								else {
  									alert('删除失败')
  								}
  							}

  							issubmit = false;
  						},
  						error: function (er) {
  							console.log(er)
  							issubmit = false;
  						}
					});
				}
			}


		    function upload_file(file) {

		    	$('.container-fluid').hide();
			    $('.upload-msg').show();

		        var xhr = new XMLHttpRequest();

		        xhr.upload.addEventListener('progress', function(evt) {
		            if (evt.lengthComputable) {
		            	var percentComplete = parseInt(evt.loaded / evt.total * 100);
		            	$('#upload-file .upload-msg .progress-txt').html(percentComplete + '%');
		            	$('#upload-file .upload-msg .progress-bar').width(percentComplete + '%');
		            	
		            }

		        }, false);

		        xhr.addEventListener('load', function(evt) {

		        	if (evt.currentTarget.status == 200) {

		        		var result = $.parseJSON(evt.currentTarget.responseText);

		        		var cursor = CodeMirrorEditor.getCursor();
                        
                        var filemd = '[' + result.name + '](' + result.url + ')';
                        
                        if (file.type.indexOf("image") > -1) {
                            filemd = '![' + result.name + '](' + result.url + ')';
                        }
                        
						CodeMirrorEditor.replaceSelection(filemd)
						//CodeMirrorEditor.focus();					
						CodeMirrorEditor.setCursor(cursor.line, cursor.ch + filemd.length);
		        		
                		$('.container-fluid').show();
				        $('.upload-msg').hide();

				        $('#upload-file .upload-msg .progress-txt').html('0%');
			            $('#upload-file .upload-msg .progress-bar').width('0%');
                        
                        
                        //sch.setSize();

            		}
		        	
		            
		        }, false);

		        xhr.addEventListener('error', function (evt) {
		        	
		            
		        }, false);

		        xhr.addEventListener('abort', function () {
		        	
		        }, false);

		        // 开始上传
		        xhr.open('POST', '/user/uploadfile/' + file.name + "/" + file.type, true);
		        xhr.send(file);  
		        
		    }
			
		</script>
	</body>
</html>